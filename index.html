<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»€éº¼éƒ½ä¸€é»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, "Microsoft JhengHei", sans-serif;
            background-color: #ffffff;
            color: #000000;
            padding: 24px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        h1 {
            font-size: 32px;
            font-weight: bold;
            color: #111827;
        }

        .login-area {
            position: relative;
        }

        .login-btn {
            background-color: #2563eb;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

            .login-btn:hover {
                background-color: #1d4ed8;
            }

        .logout-area {
            display: flex;
            align-items: center;
            gap: 12px;
        }

            .logout-area span {
                font-size: 14px;
                color: #4b5563;
            }

        .logout-btn {
            background-color: #dc2626;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

            .logout-btn:hover {
                background-color: #b91c1c;
            }

        .login-form {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background-color: white;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            width: 256px;
            z-index: 100;
        }

            .login-form input {
                width: 100%;
                border: 1px solid #d1d5db;
                padding: 6px 8px;
                border-radius: 4px;
                margin-bottom: 8px;
                font-size: 14px;
            }

        .login-form-buttons {
            display: flex;
            gap: 8px;
        }

            .login-form-buttons button {
                flex: 1;
                padding: 6px 8px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                color: white;
            }

        .submit-btn {
            background-color: #2563eb;
        }

            .submit-btn:hover {
                background-color: #1d4ed8;
            }

        .cancel-btn {
            background-color: #6b7280;
        }

            .cancel-btn:hover {
                background-color: #4b5563;
            }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid #d1d5db;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #4b5563;
            border-bottom: 2px solid transparent;
        }

            .tab:hover {
                color: #111827;
            }

            .tab.active {
                color: #2563eb;
                border-bottom-color: #2563eb;
            }

        .search-bar {
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
        }

        .search-input {
            flex: 1;
            padding: 8px 12px;
            padding-left: 40px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-wrapper {
            position: relative;
            flex: 1;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .add-btn {
            background-color: #2563eb;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

            .add-btn:hover {
                background-color: #1d4ed8;
            }

        .content {
            display: none;
        }

            .content.active {
                display: block;
            }

        table {
            width: 100%;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            border-collapse: collapse;
        }

        thead {
            background-color: #f3f4f6;
            border-bottom: 1px solid #d1d5db;
        }

        /* 1. è¨­å®šæ‰€æœ‰è¡¨æ ¼çš„ã€Œæ¨™é¡Œåˆ—ã€ (åŒ…å«æˆå“¡ã€èŠ±æœµã€ç«¶è³½) */
        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 500;
            color: #111827;
            /* âœ¨ é—œéµï¼šé€™ä¸€è¡Œæœƒè®“ä¸‰å€‹åˆ†é çš„æ¨™é¡Œé€šé€šä¸æ›è¡Œ âœ¨ */
            white-space: nowrap;
        }

        /* 2. è¨­å®šæ‰€æœ‰è¡¨æ ¼çš„ã€Œå…§å®¹åˆ—ã€ (é«˜åº¦ 30px + ä¸æ›è¡Œ) */
        #members-table td,
        #flowers-table td,
        #competitions-table td {
            height: 30px; /* å¼·åˆ¶é«˜åº¦ 30px */
            padding: 0 8px; /* ç¸®æ¸›å…§è· */
            line-height: 30px; /* å‚ç›´ç½®ä¸­ */
            /* âœ¨ é—œéµï¼šè®“å…§å®¹å¤ªé•·æ™‚è®Šæˆ "..." è€Œä¸æ˜¯æ›è¡Œæ’é«˜ */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            color: #111827;
        }

        tr:hover {
            background-color: #f9fafb;
        }

        .sub-row {
            background-color: #f9fafb !important;
        }

            .sub-row td {
                padding: 8px 16px;
                font-size: 14px;
                color: #4b5563;
            }

        .actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .edit-btn, .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
        }

        .edit-btn {
            color: #2563eb;
        }

            .edit-btn:hover {
                color: #1d4ed8;
            }

        .delete-btn {
            color: #dc2626;
        }

            .delete-btn:hover {
                color: #b91c1c;
            }

        .form-row {
            background-color: #f9fafb;
        }

        .form-container {
            padding: 16px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .form-container input,
        .form-container select,
        .form-container textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }

            .form-container input:disabled,
            .form-container select:disabled,
            .form-container textarea:disabled {
                background-color: #f3f4f6;
                cursor: not-allowed;
            }

        .form-buttons {
            display: flex;
            gap: 8px;
        }

            .form-buttons button {
                flex: 1;
                padding: 8px 16px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                color: white;
                font-size: 14px;
            }

        .save-btn {
            background-color: #16a34a;
        }

            .save-btn:hover {
                background-color: #15803d;
            }

            .save-btn:disabled {
                background-color: #9ca3af;
                cursor: not-allowed;
            }

        .form-cancel-btn {
            background-color: #6b7280;
        }

            .form-cancel-btn:hover {
                background-color: #4b5563;
            }

        .flower-form-box {
            background-color: white;
            border: 1px solid #d1d5db;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .grade-red {
            color: #ef4444;
            font-weight: bold;
        }

        .grade-orange {
            color: #f97316;
            font-weight: bold;
        }

        .grade-purple {
            color: #a855f7;
            font-weight: bold;
        }

        .grade-blue {
            color: #3b82f6;
            font-weight: bold;
        }

        .grade-green {
            color: #22c55e;
            font-weight: bold;
        }

        .checkbox-list {
            max-height: 160px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px;
            cursor: pointer;
        }

            .checkbox-item:hover {
                background-color: #f3f4f6;
            }

        .hidden {
            display: none !important;
        }
        /* âœ¨ çµ±ä¸€è¨­å®šæ‰€æœ‰è¡¨æ ¼ (æˆå“¡ã€èŠ±æœµã€ç«¶è³½) çš„é«˜åº¦ç‚º 30px âœ¨ */
        #members-table td,
        #flowers-table td,
        #competitions-table td {
            height: 30px; /* å¼·åˆ¶é«˜åº¦ 30px */
            padding: 0 8px; /* ä¸Šä¸‹å…§è·æ­¸é›¶ */
            line-height: 30px; /* è®“æ–‡å­—å‚ç›´ç½®ä¸­ */
            /* é˜²æ­¢å…§å®¹å¤ªé•·æ’é–‹é«˜åº¦ (å­—å¤ªå¤šæœƒè®Š ...) */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px; /* è¨­å®šæœ€å¤§å¯¬åº¦ï¼Œé¿å…è¡¨æ ¼è¢«é•·æ–‡å­—æ’å£ */
        }

        /* å¾®èª¿æ‰€æœ‰è¡¨æ ¼çš„æ“ä½œæŒ‰éˆ•ï¼Œè®“å®ƒå¡å¾—é€² 30px çš„æ ¼å­ */
        #members-table .actions,
        #flowers-table .actions,
        #competitions-table .actions {
            margin: 0;
            padding: 0;
            height: 100%;
            display: flex;
            align-items: center; /* æŒ‰éˆ•å‚ç›´ç½®ä¸­ */
            justify-content: center;
        }

        /* è®“ã€Œç­‰ç´šã€æ¬„ä½ (èŠ±æœµæ¸…å–®) çš„æ¨™ç±¤å­—é«”ç¨å¾®ç¸®å°ï¼Œæ‰ä¸æœƒåˆ‡åˆ° */
        .grade-red, .grade-orange, .grade-purple, .grade-blue, .grade-green {
            font-size: 13px;
        }

        /* âœ¨ é€šç”¨è©³ç´°è³‡æ–™å¡ç‰‡ (Modal) âœ¨ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s; /* æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
        }

            .modal.show {
                opacity: 1;
                visibility: visible;
            }

        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 400px;
            max-height: 85vh;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            overflow-y: auto;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.2s; /* ç¸®æ”¾å‹•ç•« */
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        /* å¡ç‰‡å…§å®¹æ’ç‰ˆ */
        .modal-header {
            border-bottom: 1px solid #eee;
            padding-bottom: 12px;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: bold;
            color: #111827;
        }

        .modal-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin-top: 4px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            border-bottom: 1px dashed #f3f4f6;
            padding-bottom: 8px;
        }

        .detail-label {
            font-size: 13px;
            color: #6b7280;
        }

        .detail-value {
            font-size: 15px;
            color: #111827;
            font-weight: 500;
            text-align: right;
            max-width: 70%;
        }

        .section-title {
            font-size: 13px;
            color: #9ca3af;
            margin-top: 20px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* å½©è‰²èŠ±æœµæ¨™ç±¤ */
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .flower-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 500;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            color: #374151;
        }

        /* é—œé–‰æŒ‰éˆ• */
        .modal-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: #f3f4f6;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 20px;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

            .modal-close-btn:hover {
                background: #e5e7eb;
                color: #111827;
            }

        /* è®“è¡¨æ ¼è£¡çš„å­—è®Šè—è‰²å¯é»æ“Š */
        .clickable-link {
            color: #2563eb;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            position: relative;
        }

            .clickable-link:hover {
                text-decoration: underline;
                color: #1d4ed8;
            }

        /* âœ¨ æ•‘æ´è¡¨å–®ï¼šè®“æ–°å¢/ç·¨è¼¯è¡¨å–®çš„æ¬„ä½è‡ªå‹•é•·é«˜ï¼Œä¸è¦è¢«é–æ­»åœ¨ 30px âœ¨ */
        tr.form-row td {
            height: auto !important; /* è§£é™¤é«˜åº¦é™åˆ¶ */
            white-space: normal !important; /* å…è¨±å…§å®¹æ›è¡Œ */
            overflow: visible !important; /* å…è¨±å…§å®¹è¶…å‡º */
            max-width: none !important; /* è§£é™¤å¯¬åº¦é™åˆ¶ */
            padding: 16px !important; /* çµ¦è¡¨å–®èˆ’æœçš„å…§è· */
        }

        /* âœ¨ æ•‘æ´ Checkboxï¼šé˜²æ­¢å®ƒè¢«æ’å¤§ï¼Œè®“æ–‡å­—é¡¯ç¤ºå‡ºä¾† âœ¨ */
        .form-container input[type="checkbox"] {
            width: auto !important; /* å¯¬åº¦å›å¾©æ­£å¸¸ (ä¸è¦100%) */
            height: auto !important; /* é«˜åº¦å›å¾©æ­£å¸¸ */
            margin-right: 8px !important; /* èˆ‡æ–‡å­—ä¿æŒè·é›¢ */
            padding: 0 !important; /* ç§»é™¤å¤šé¤˜å…§è· */
            border: none !important; /* ç§»é™¤é‚Šæ¡† */
            display: inline-block; /* ç¢ºä¿ä¸¦æ’é¡¯ç¤º */
            flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
        }

        /* ç¢ºä¿æ‰‹æ©Ÿç‰ˆæ¨™ç±¤æ–‡å­—ä¸æœƒè¢«åˆ‡æ‰ */
        .checkbox-item {
            align-items: center !important;
            overflow: visible !important; /* å…è¨±æ–‡å­—å‡¸å‡ºä¾† (å¦‚æœå¤ªé•·) */
        }

        /* âœ¨ å…¬æœƒç®¡ç†å€æ¨£å¼ âœ¨ */
        .guild-manager-box {
            background-color: #f0f9ff; /* æ·ºè—è‰²èƒŒæ™¯ */
            border: 1px solid #bae6fd;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .guild-manager-title {
            font-size: 16px;
            font-weight: bold;
            color: #0369a1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .guild-input-group {
            display: flex;
            gap: 8px;
            max-width: 400px;
        }

        /* å…¬æœƒæ¨™ç±¤ (å¯åˆªé™¤) */
        .guild-tag {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            background-color: white;
            border: 1px solid #cbd5e1;
            border-radius: 20px;
            font-size: 14px;
            color: #334155;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .guild-delete-btn {
            margin-left: 8px;
            color: #ef4444;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

            .guild-delete-btn:hover {
                background-color: #fee2e2;
            }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¨™é¡Œå’Œç™»å…¥å€ -->
        <div class="header">
            <h1>ä»€éº¼éƒ½ä¸€é»</h1>
            <div class="login-area">
                <div id="loginButton">
                    <button class="login-btn" onclick="showLoginForm()">ç®¡ç†å“¡ç™»å…¥</button>
                </div>
                <div id="loginFormBox" class="login-form hidden">
                    <form onsubmit="handleLogin(event)">
                        <input type="text" id="username" placeholder="å¸³è™Ÿ" required>
                        <input type="password" id="password" placeholder="å¯†ç¢¼" required>
                        <div class="login-form-buttons">
                            <button type="submit" class="submit-btn">ç™»å…¥</button>
                            <button type="button" class="cancel-btn" onclick="hideLoginForm()">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
                <div id="logoutArea" class="logout-area hidden">
                    <span>å·²ç™»å…¥ç®¡ç†å“¡</span>
                    <button class="logout-btn" onclick="handleLogout()">ç™»å‡º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ†é  -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('members')">æˆå“¡æ¸…å–®</button>
        <button class="tab" onclick="switchTab('flowers')">èŠ±æœµæ¸…å–®</button>
        <button class="tab" onclick="switchTab('competitions')">æœ¬é€±ç«¶è³½</button>
    </div>

    <div id="members-content" class="content active">

        <div id="guild-manager-area" class="guild-manager-box hidden">
            <div class="guild-manager-title">ğŸ¢ å…¬æœƒç®¡ç† (åƒ…ç®¡ç†å“¡å¯è¦‹)</div>
            <div class="guild-input-group">
                <input type="text" id="new-guild-name" placeholder="è¼¸å…¥æ–°å…¬æœƒåç¨±" style="flex:1;">
                <button class="add-btn" onclick="addGuild()">æ–°å¢</button>
            </div>
            <div style="font-size: 13px; color: #64748b; margin-top: 4px;">ç›®å‰å·²å»ºç«‹çš„å…¬æœƒ (é»æ“Š X å¯åˆªé™¤)ï¼š</div>
            <div id="guild-list-display" class="tags-container" style="margin-top: 8px;">
            </div>
        </div>
        <div class="search-bar">
            <div class="search-bar">
                <div class="search-wrapper">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" class="search-input" id="members-search" placeholder="æœå°‹æˆå“¡åç¨±..." onkeyup="searchTable('members')">
                </div>
            </div>
        </div>
        <div style="margin-bottom: 16px;">
            <button class="add-btn" onclick="showMemberForm()">
                â• æ–°å¢æˆå“¡
            </button>
        </div>
        <table>
            <thead>
                <tr>
                    <th>éŠæˆ²åç¨±</th>
                    <th>éŠæˆ²ID</th>
                    <th>å…¬æœƒ</th>
                    <th class="center">æ“æœ‰èŠ±</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="members-table"></tbody>
        </table>
    </div> <div id="flowers-content" class="content">
        <div class="search-bar">
            <div class="search-wrapper">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="search-input" id="flowers-search" placeholder="æœå°‹èŠ±æœµåç¨±..." onkeyup="searchTable('flowers')">
            </div>
        </div>
        <div style="margin-bottom: 16px;">
            <button class="add-btn" onclick="toggleFlowerForm()">
                â• <span id="flower-btn-text">æ–°å¢èŠ±æœµè³‡æ–™</span>
            </button>
        </div>
        <div id="flower-form-box" class="flower-form-box hidden"></div>
        <table>
            <thead>
                <tr>
                    <th>èŠ±æœµåç¨±</th>
                    <th>èª°æ“æœ‰</th>
                    <th onclick="sortFlowersByGrade()" style="cursor: pointer; user-select: none;">
                        ç­‰ç´š <span id="grade-sort-icon">â†•</span>
                    </th>
                    <th onclick="sortFlowersByScore()" style="cursor: pointer; user-select: none;">
                        ç«¶è³½åˆ†æ•¸ <span id="score-sort-icon">â†•</span>
                    </th>
                    <th>ä¸Šå¸‚æ—¥æœŸ</th>
                    <th>èŠ±ç“¶</th>
                    <th>å‚™è¨»</th>
                    <th>ä¾†æº</th>
                    <th class="center">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="flowers-table"></tbody>
        </table>
    </div>


    <div id="competitions-content" class="content">

        <div class="search-bar">
            <div class="search-wrapper">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="search-input" id="competitions-flower-search"
                       placeholder="æœå°‹åƒè³½èŠ±æœµ (ä»»æ„æ–‡å­—)..." onkeyup="renderCompetitions()">
            </div>
        </div>

        <div style="margin-bottom: 16px;">
            <button class="add-btn" onclick="showCompetitionForm()">
                â• æ–°å¢ç«¶è³½è¨˜éŒ„
            </button>
        </div>

        <div class="search-bar">
            <select id="comp-guild-filter" onchange="renderCompetitions()" style="
                    padding: 8px;
                    border: 1px solid #d1d5db;
                    border-radius: 8px;
                    margin-right: 12px;
                    cursor: pointer;
                ">
                <option value="">å…¨éƒ¨å…¬æœƒ</option>
            </select>

            <div class="search-wrapper">
                <span class="search-icon">ğŸ”</span>
                <input type="text" class="search-input" id="competitions-member-search"
                       placeholder="æœå°‹æˆå“¡åç¨± (ä»»æ„æ–‡å­—)..." onkeyup="renderCompetitions()">
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>æˆå“¡åç¨±</th>
                    <th>é¸æ“‡çš„èŠ±æœµ</th>
                    <th class="center">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="competitions-table"></tbody>
        </table>
    </div>

    <div id="universal-modal" class="modal" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close-btn" onclick="closeModal()">Ã—</button>
            <div id="modal-body-content">
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        const API_URL = 'https://script.google.com/macros/s/AKfycbxSz_k-fDZDs9hzo2vpNqV6KUccUhGpA5-Vh5ZS64CSjsh6MR_8CsSwbUw9_6gv0w5qSw/exec';

        const ADMIN_USERNAME = 'yidiandian5000009';
        const ADMIN_PASSWORD = 'Yidiandian01';
        let isAuthenticated = false;
        let currentTab = 'members';
        let members = [];
        let flowers = [];
        let competitions = [];

        let guilds = []; // è®Šæˆç©ºé™£åˆ—ï¼Œç­‰å¾…å¾é›²ç«¯è®€å–
        const flowerSources = ['æ´»å‹•', 'ç•¶é€±ç¦®åŒ…èŠ±', 'èŠ±ä¹‹å¯†ä»¤', 'èŠ±éˆ', 'èŠ±åœƒç¦®åŒ…', 'æ™‚å…‰å•†åº—', 'èŠ±éˆå•†åº—', 'èŠ±åŠ', 'VIPå•†åº—', 'ç­‰ç´šèŠ±'];
        const flowerGrades = [
            { value: 'ç´…(ä»™å“)', label: 'ç´…(ä»™å“)', color: 'red' },
            { value: 'æ©™(è¯å“)', label: 'æ©™(è¯å“)', color: 'orange' },
            { value: 'ç´«(çå“)', label: 'ç´«(çå“)', color: 'purple' },
            { value: 'è—(æ™®å“)', label: 'è—(æ™®å“)', color: 'blue' },
            { value: 'ç¶ (å‡¡å“)', label: 'ç¶ (å‡¡å“)', color: 'green' }
        ];

        // åˆå§‹åŒ–
        function init() {
            loadData();
        }

        async function loadData() {
            try {
                document.body.style.cursor = 'wait';

                // 1. å–å¾—è³‡æ–™
                const response = await fetch(API_URL + '?action=getData');
                const text = await response.text();

                // 2. æ¸…é™¤éš±å½¢ç©ºç™½ä¸¦è½‰æˆè³‡æ–™
                let data;
                try {
                    data = JSON.parse(text.trim());
                } catch (e) {
                    console.error('JSON è§£æå¤±æ•—', e);
                    throw new Error('è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Google Sheet');
                }

                // 3. æ›´æ–°è®Šæ•¸
                members = data.members || [];
                flowers = data.flowers || [];
                competitions = data.competitions || [];
                guilds = data.guilds || []; // âœ¨ åŠ å…¥é€™è¡Œï¼šè®€å–é›²ç«¯å…¬æœƒè³‡æ–™

                // è³‡æ–™ä¿®å¾©æ©Ÿåˆ¶ (ä¿æŒåŸæœ¬çš„é‚è¼¯)
                members.forEach(m => {
                    if (!Array.isArray(m.ownedFlowers)) {
                        if (typeof m.ownedFlowers === 'string') {
                            if (m.ownedFlowers.trim().startsWith('[')) {
                                try { m.ownedFlowers = JSON.parse(m.ownedFlowers); } catch (e) { m.ownedFlowers = []; }
                            } else if (m.ownedFlowers.trim() !== '') {
                                m.ownedFlowers = m.ownedFlowers.split(',').map(s => s.trim());
                            } else { m.ownedFlowers = []; }
                        } else { m.ownedFlowers = []; }
                    }
                });

                competitions.forEach(c => {
                    if (!Array.isArray(c.selectedFlowers)) {
                        if (typeof c.selectedFlowers === 'string' && c.selectedFlowers.trim().startsWith('[')) {
                            try { c.selectedFlowers = JSON.parse(c.selectedFlowers); } catch (e) { c.selectedFlowers = []; }
                        } else { c.selectedFlowers = []; }
                    }
                });

                // 4. æ¸²æŸ“ç•«é¢
                renderMembers();
                renderFlowers();
                renderCompetitions();
                renderGuildManager(); // âœ¨ åŠ å…¥é€™è¡Œï¼šæ¸²æŸ“å…¬æœƒç®¡ç†å€
                // âœ¨ è«‹ç¢ºä¿é€™è£¡æœ‰é€™ä¸€è¡Œï¼š
                initCompGuildFilter();

                document.body.style.cursor = 'default';
                console.log('é›²ç«¯è³‡æ–™è¼‰å…¥ä¸¦ä¿®å¾©æˆåŠŸï¼');

            } catch (error) {
                console.error('è¼‰å…¥å¤±æ•—:', error);
                alert('è®€å–å¤±æ•—ï¼ŒéŒ¯èª¤è¨Šæ¯ï¼š' + error.message);
                document.body.style.cursor = 'default';
            }
        }

        // è«‹æ”¾åœ¨ loadData() æˆåŠŸè¼‰å…¥è³‡æ–™ä¹‹å¾Œï¼Œæˆ–æ˜¯æ”¾åœ¨ renderCompetitions() é™„è¿‘
        // åˆå§‹åŒ–æˆ–æ›´æ–°ç«¶è³½é é¢çš„å…¬æœƒç¯©é¸å™¨
        function initCompGuildFilter() {
            const filterSelect = document.getElementById('comp-guild-filter');

            // âœ¨ åˆ¤æ–·ï¼šå¦‚æœæ²’æœ‰å…¬æœƒè³‡æ–™ï¼Œå°±ç›´æ¥éš±è—é€™å€‹ä¸‹æ‹‰é¸å–®
            if (guilds.length === 0) {
                filterSelect.style.display = 'none';
                filterSelect.innerHTML = '<option value="">å…¨éƒ¨å…¬æœƒ</option>'; // ä¿æŒçµæ§‹ä½†ä¸é¡¯ç¤º
                return;
            }

            // å¦‚æœæœ‰å…¬æœƒï¼Œå°±é¡¯ç¤ºä¸¦å¡«å…¥é¸é …
            filterSelect.style.display = ''; // æ¢å¾©é¡¯ç¤º
            filterSelect.innerHTML = '<option value="">å…¨éƒ¨å…¬æœƒ</option>';

            guilds.forEach(g => {
                const option = document.createElement('option');
                option.value = g;
                option.textContent = g;
                filterSelect.appendChild(option);
            });
        }

        // å„²å­˜è³‡æ–™
        function saveDataToCloud(type, dataContent) {
            const saveBtn = document.querySelector('.save-btn');
            if (saveBtn) { saveBtn.textContent = 'â˜ï¸ å„²å­˜ä¸­...'; saveBtn.disabled = true; }

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    type: type,
                    content: dataContent
                })
            })
                .then(res => res.json())
                .then(result => {
                    console.log(type + ' å„²å­˜æˆåŠŸ');
                    if (saveBtn) { saveBtn.textContent = 'ğŸ’¾ å„²å­˜'; saveBtn.disabled = false; }
                })
                .catch(err => {
                    console.error('å„²å­˜å¤±æ•—', err);
                    alert('å„²å­˜å¤±æ•—ï¼Œè«‹å‚™ä»½è³‡æ–™ï¼');
                    if (saveBtn) { saveBtn.textContent = 'ğŸ’¾ å„²å­˜'; saveBtn.disabled = false; }
                });
        }

        // ç™»å…¥ç›¸é—œ
        function showLoginForm() {
            document.getElementById('loginFormBox').classList.remove('hidden');
        }

        function hideLoginForm() {
            document.getElementById('loginFormBox').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function handleLogin(event) {
            event.preventDefault();
            const usernameInput = document.getElementById('username').value;
            const passwordInput = document.getElementById('password').value;

            if (usernameInput === ADMIN_USERNAME && passwordInput === ADMIN_PASSWORD) {
                isAuthenticated = true;
                document.getElementById('guild-manager-area').classList.remove('hidden');
                document.getElementById('loginButton').classList.add('hidden');
                document.getElementById('loginFormBox').classList.add('hidden');
                document.getElementById('logoutArea').classList.remove('hidden');
                // ç™»å…¥å¾Œé‡æ–°æ¸²æŸ“ï¼Œè§£é–æŒ‰éˆ•
                renderMembers();
                renderFlowers();
                renderCompetitions();
                renderGuildManager(); // é‡æ–°æ¸²æŸ“ç®¡ç†å€
            } else {
                alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼');
            }
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function handleLogout() {
            isAuthenticated = false;
            document.getElementById('loginButton').classList.remove('hidden');
            document.getElementById('logoutArea').classList.add('hidden');
            // âœ¨ åŠ å…¥é€™è¡Œï¼šéš±è—å…¬æœƒç®¡ç†å€
            document.getElementById('guild-manager-area').classList.add('hidden');

            renderMembers();
        }
        // ç™»å‡ºå¾Œé‡æ–°æ¸²æŸ“ï¼Œé–ä½æŒ‰éˆ•
        renderMembers();
        renderFlowers();
        renderCompetitions();


        // åˆ†é åˆ‡æ›
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));

            // é€™è£¡åŸæœ¬ç”¨ event.targetï¼Œä½†ç‚ºäº†é¿å…éŒ¯èª¤ï¼Œæ”¹ç”¨ querySelector
            const activeBtn = Array.from(document.querySelectorAll('.tab')).find(b => b.textContent.includes(
                tab === 'members' ? 'æˆå“¡' : tab === 'flowers' ? 'èŠ±æœµ' : 'ç«¶è³½'
            ));
            if (activeBtn) activeBtn.classList.add('active');

            document.getElementById(tab + '-content').classList.add('active');
        }

        // æœå°‹åŠŸèƒ½
        // æœå°‹åŠŸèƒ½ (æŒ‡å®šæ¬„ä½ç‰ˆ)
        function searchTable(type) {
            // 1. å–å¾—è¼¸å…¥æ–‡å­— (ä¸¦å»é™¤å‰å¾Œç©ºç™½)
            const searchValue = document.getElementById(type + '-search').value.toLowerCase().trim();
            const table = document.getElementById(type + '-table');
            const rows = table.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                // è·³éè¡¨å–®åˆ—å’Œéš±è—åˆ—
                if (row.classList.contains('form-row') || row.classList.contains('sub-row')) continue;

                let targetText = '';

                // âœ¨ é—œéµä¿®æ”¹ï¼šæŒ‡å®šè¦æœå°‹å“ªä¸€æ ¼ (index 0 ä»£è¡¨ç¬¬ä¸€æ¬„)
                if (type === 'members') {
                    // æˆå“¡æ¸…å–®ï¼šåªæœç¬¬ä¸€æ¬„ (éŠæˆ²åç¨±)
                    targetText = row.cells[0] ? row.cells[0].textContent : '';
                } else if (type === 'flowers') {
                    // èŠ±æœµæ¸…å–®ï¼šåªæœç¬¬ä¸€æ¬„ (èŠ±æœµåç¨±)
                    targetText = row.cells[0] ? row.cells[0].textContent : '';
                } else {
                    // å…¶ä»–æƒ…æ³ (é é˜²è¬ä¸€)ï¼šæœæ•´è¡Œ
                    targetText = row.textContent;
                }

                // æ¯”å°æ–‡å­— (åªè¦åŒ…å«æœå°‹å­—å°±é¡¯ç¤º)
                if (targetText.toLowerCase().includes(searchValue)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        function showMemberForm(member = null) {
            const isEdit = member !== null;
            const tbody = document.getElementById('members-table');

            const existingForm = tbody.querySelector('.form-row');
            if (existingForm) existingForm.remove();

            // 1. æº–å‚™èŠ±æœµå‹¾é¸æ¸…å–® HTML
            let flowersHtml = '';
            if (flowers.length === 0) {
                flowersHtml = '<div style="padding:4px; color:#666; grid-column: 1/-1;">å°šæœªå»ºç«‹èŠ±æœµè³‡æ–™</div>';
            } else {
                flowersHtml = flowers.map(f => `
                <label class="checkbox-item" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    <input type="checkbox" name="member-flower-select" value="${f.name}"
                        ${member && member.ownedFlowers && member.ownedFlowers.includes(f.name) ? 'checked' : ''}>
                    <span style="margin-left:4px; font-size: 13px;">${f.name}</span>
                </label>
            `).join('');
            }

            // 2. æº–å‚™å…¬æœƒé¸å–® HTML
            let guildInputHtml = '';
            if (guilds.length > 0) {
                guildInputHtml = `
                <select id="member-guild" required style="grid-column: span 2;">
                    <option value="">é¸æ“‡å…¬æœƒ*</option>
                    ${guilds.map(g => `<option value="${g}" ${member && member.guild === g ? 'selected' : ''}>${g}</option>`).join('')}
                </select>
            `;
            } else {
                guildInputHtml = `<input type="hidden" id="member-guild" value="">`;
            }

            const isLocked = isEdit && !isAuthenticated;

            // 3. çµ„åˆè¡¨å–® HTML
            const formRow = document.createElement('tr');
            formRow.className = 'form-row';
            formRow.innerHTML = `
            <td colspan="5">
                <div class="form-container">
                    <form onsubmit="saveMember(event, ${isEdit ? member.id : 'null'})">
                        <div class="form-grid">
                            <input type="text" id="member-gameName" placeholder="éŠæˆ²åç¨±*" value="${member ? member.gameName : ''}" ${isLocked ? 'disabled' : ''} required>
                            <input type="text" id="member-gameId" placeholder="éŠæˆ²ID*" value="${member ? member.gameId : ''}" ${isLocked ? 'disabled' : ''} required>

                            ${guildInputHtml}

                            <div style="grid-column: span 2;">
                                <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">æ“æœ‰çš„èŠ±æœµ (æ‰€æœ‰äººçš†å¯ä¿®æ”¹)ï¼š</label>

                                <input type="text" placeholder="ğŸ” æœå°‹èŠ±æœµ..."
                                    oninput="filterCheckboxes(this, 'member-flower-list')"
                                    style="width: 100%; padding: 6px; margin-bottom: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;">

                                <div style="margin-bottom: 8px; display: flex; gap: 8px;">
                                    <button type="button" onclick="toggleAllFlowers(true)"
                                        style="padding: 4px 12px; font-size: 12px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer; color: #374151;">
                                        âœ… å…¨é¸
                                    </button>
                                    <button type="button" onclick="toggleAllFlowers(false)"
                                        style="padding: 4px 12px; font-size: 12px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer; color: #374151;">
                                        â¬œ å…¨ä¸é¸
                                    </button>
                                </div>

                                <div id="member-flower-list" class="checkbox-list" style="
                                    background: white;
                                    max-height: 200px;
                                    display: grid;
                                    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                                    gap: 4px;
                                ">
                                    ${flowersHtml}
                                </div>
                            </div>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="save-btn">ğŸ’¾ å„²å­˜</button>
                            <button type="button" class="form-cancel-btn" onclick="renderMembers()">âŒ å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
            </td>
        `;

            if (isEdit) {
                const rows = tbody.getElementsByTagName('tr');
                for (let i = 0; i < rows.length; i++) {
                    if (member && rows[i].innerHTML.includes(member.gameId)) {
                        rows[i].replaceWith(formRow);
                        break;
                    }
                }
            } else {
                tbody.insertBefore(formRow, tbody.firstChild);
            }
        }
        function editMember(id) {
            // æ‰€æœ‰äººéƒ½å¯ä»¥é»æ“Šç·¨è¼¯ï¼Œä½†æ¬Šé™æœƒåœ¨ showMemberForm è£¡é¢æ§åˆ¶ (é–æ¬„ä½)
            const member = members.find(m => m.id === id);
            showMemberForm(member);
        }

        function saveMember(event, id) {
            event.preventDefault();

            const gameNameInput = document.getElementById('member-gameName');
            const gameIdInput = document.getElementById('member-gameId');
            const guildInput = document.getElementById('member-guild'); // å¯èƒ½æ˜¯é¸å–®ä¹Ÿå¯èƒ½æ˜¯éš±è—æ¬„ä½

            // å–å¾—æ–°è¼¸å…¥çš„åå­—
            const newName = gameNameInput.value.trim();

            // å–å¾—é¸ä¸­çš„èŠ±æœµ
            const checkboxes = document.querySelectorAll('input[name="member-flower-select"]:checked');
            const ownedFlowers = Array.from(checkboxes).map(cb => cb.value);

            if (id) {
                // --- ç·¨è¼¯æ¨¡å¼ ---
                const index = members.findIndex(m => m.id === id);
                if (index === -1) return;

                // âœ¨ é—œéµæ­¥é©Ÿ 1: è¨˜éŒ„åŸæœ¬çš„èˆŠåå­—
                const oldName = members[index].gameName;

                if (isAuthenticated) {
                    // ç®¡ç†å“¡ï¼šæ›´æ–°å…¨éƒ¨
                    members[index] = {
                        ...members[index],
                        gameName: newName,
                        gameId: gameIdInput.value,
                        guild: guildInput.value,
                        ownedFlowers
                    };
                } else {
                    // ä¸€èˆ¬äººï¼šåªæ›´æ–°å…¬æœƒå’ŒèŠ±æœµï¼Œåå­—IDç¶­æŒåŸæ¨£ (é˜²æ­¢è¢«äº‚æ”¹)
                    // ä½†å¦‚æœé€™é‚Šæ²’æ”¹åï¼ŒoldName === newNameï¼Œä¸‹é¢çš„é€£å‹•é‚è¼¯å°±ä¸æœƒåŸ·è¡Œï¼Œæ‰€ä»¥æ²’é—œä¿‚
                    members[index] = {
                        ...members[index],
                        guild: guildInput.value,
                        ownedFlowers
                    };
                }

                // âœ¨ é—œéµæ­¥é©Ÿ 2: æª¢æŸ¥åå­—æ˜¯å¦æ”¹è®Šï¼Œè‹¥æ”¹è®Šå‰‡é€£å‹•æ›´æ–° [ç«¶è³½ç´€éŒ„]
                if (isAuthenticated && oldName !== newName) {
                    let competitionUpdated = false;

                    competitions.forEach(c => {
                        // æ¯”å°èˆŠåå­— (åŠ ä¸Š String è½‰å‹é¿å…æ•¸å­—åå­—å‡ºéŒ¯)
                        if (String(c.memberName) === String(oldName)) {
                            c.memberName = newName; // æ›æˆæ–°åå­—
                            competitionUpdated = true;
                        }
                    });

                    // å¦‚æœæœ‰æ›´æ–°åˆ°ç«¶è³½ç´€éŒ„ï¼Œå°±å­˜æª”ä¸¦é‡ç¹ª
                    if (competitionUpdated) {
                        saveDataToCloud('competitions', competitions);
                        renderCompetitions();
                        console.log(`å·²è‡ªå‹•å°‡ç«¶è³½ç´€éŒ„ä¸­çš„ã€Œ${oldName}ã€æ›´æ–°ç‚ºã€Œ${newName}ã€`);
                    }
                }

            } else {
                // --- æ–°å¢æ¨¡å¼ ---
                members.push({
                    id: Date.now(),
                    gameName: newName,
                    gameId: gameIdInput.value,
                    guild: guildInput.value,
                    ownedFlowers
                });
            }

            // å„²å­˜æˆå“¡è³‡æ–™
            saveDataToCloud('members', members);

            // æ›´æ–°ç•«é¢
            renderMembers();
            renderFlowers(); // é€£å‹•æ›´æ–°èŠ±æœµåˆ—è¡¨çš„æ“æœ‰è€…
        }
        function deleteMember(id) {
            // âœ… å¿…é ˆä¿ç•™é€™æ®µï¼Œç¢ºä¿ä¸€èˆ¬äººç„¡æ³•é€éç¨‹å¼ç¢¼åˆªé™¤
            if (!isAuthenticated) {
                alert('æ¬Šé™ä¸è¶³ï¼šåƒ…é™ç®¡ç†å“¡å¯åˆªé™¤æˆå“¡ã€‚');
                return;
            }

            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æˆå“¡å—?')) {
                members = members.filter(m => m.id !== id);
                saveDataToCloud('members', members);
                renderMembers();
            }
        }

        function toggleFlowerForm() {
            const formBox = document.getElementById('flower-form-box');
            const btnText = document.getElementById('flower-btn-text');

            if (formBox.classList.contains('hidden')) {
                showFlowerFormInBox();
                btnText.textContent = 'å–æ¶ˆæ–°å¢';
            } else {
                formBox.classList.add('hidden');
                formBox.innerHTML = '';
                btnText.textContent = 'æ–°å¢èŠ±æœµè³‡æ–™';
            }
        }

        function showFlowerFormInBox(flower = null) {
            const isEdit = flower !== null;
            const formBox = document.getElementById('flower-form-box');

            // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ä½†æ²’æœ‰ç™»å…¥ï¼Œæ ¹æœ¬ä¸è©²é–‹å•Ÿé€™å€‹è¡¨å–®(é›™é‡é˜²è­·)
            if (isEdit && !isAuthenticated) {
                alert('æ¬Šé™ä¸è¶³');
                return;
            }

            formBox.innerHTML = `
                                                    <form onsubmit="saveFlower(event, ${isEdit ? flower.id : 'null'})">
                                                        <div class="form-grid">
                                                            <input type="text" id="flower-name" placeholder="èŠ±æœµåç¨±*" value="${flower ? flower.name : ''}" required>
                                                            <select id="flower-source" required>
                                                                <option value="">é¸æ“‡ä¾†æº*</option>
                                                                ${flowerSources.map(s => `<option value="${s}" ${flower && flower.source === s ? 'selected' : ''}>${s}</option>`).join('')}
                                                            </select>
                                                            <select id="flower-grade" required>
                                                                <option value="">é¸æ“‡ç­‰ç´š*</option>
                                                                ${flowerGrades.map(g => `<option value="${g.value}" ${flower && flower.grade === g.value ? 'selected' : ''}>${g.label}</option>`).join('')}
                                                            </select>
                                                            <input type="number" id="flower-score" placeholder="ç«¶è³½åˆ†æ•¸*" value="${flower ? flower.competitionScore : ''}" required>
                                                            <input type="date" id="flower-date" value="${flower ? flower.releaseDate : ''}">
                                                            <input type="text" id="flower-vase" placeholder="èŠ±ç“¶" value="${flower ? flower.vase : ''}">
                                                        </div>
                                                        <textarea id="flower-note" placeholder="å‚™è¨»" rows="2">${flower ? flower.note : ''}</textarea>
                                                        <div class="form-buttons" style="margin-top: 12px;">
                                                            <button type="submit" class="save-btn">ğŸ’¾ å„²å­˜</button>
                                                            <button type="button" class="form-cancel-btn" onclick="closeFlowerForm()">âŒ å–æ¶ˆ</button>
                                                        </div>
                                                    </form>
                                                `;

            formBox.classList.remove('hidden');
        }

        function closeFlowerForm() {
            const formBox = document.getElementById('flower-form-box');
            const btnText = document.getElementById('flower-btn-text');
            if (formBox) formBox.classList.add('hidden');
            if (formBox) formBox.innerHTML = '';
            if (btnText) btnText.textContent = 'æ–°å¢èŠ±æœµè³‡æ–™';
            renderFlowers();
        }

        function saveFlower(event, id) {
            event.preventDefault();

            // æ¬Šé™æª¢æŸ¥ï¼šç·¨è¼¯èˆŠè³‡æ–™å¿…é ˆæ˜¯ç®¡ç†å“¡
            if (id && !isAuthenticated) {
                alert('æ¬Šé™ä¸è¶³ï¼šåªæœ‰ç®¡ç†å“¡å¯ä»¥ä¿®æ”¹èŠ±æœµè³‡æ–™ã€‚');
                return;
            }

            const name = document.getElementById('flower-name').value;
            const source = document.getElementById('flower-source').value;
            const grade = document.getElementById('flower-grade').value;
            const competitionScore = parseInt(document.getElementById('flower-score').value);
            const releaseDate = document.getElementById('flower-date').value;
            const vase = document.getElementById('flower-vase').value;
            const note = document.getElementById('flower-note').value;

            if (id) {
                const index = flowers.findIndex(f => f.id === id);
                const oldName = flowers[index].name;

                flowers[index] = { ...flowers[index], name, source, grade, competitionScore, releaseDate, vase, note };

                // æ”¹åé€£å‹•
                if (oldName !== name) {
                    let memberUpdated = false;
                    let competitionUpdated = false;
                    members.forEach(m => {
                        if (m.ownedFlowers && m.ownedFlowers.includes(oldName)) {
                            m.ownedFlowers = m.ownedFlowers.map(f => f === oldName ? name : f);
                            memberUpdated = true;
                        }
                    });
                    competitions.forEach(c => {
                        if (c.selectedFlowers && c.selectedFlowers.includes(oldName)) {
                            c.selectedFlowers = c.selectedFlowers.map(f => f === oldName ? name : f);
                            competitionUpdated = true;
                        }
                    });
                    if (memberUpdated) saveDataToCloud('members', members);
                    if (competitionUpdated) saveDataToCloud('competitions', competitions);
                }
            } else {
                // æ–°å¢ (æ‰€æœ‰äººéƒ½å¯ä»¥)
                flowers.push({ id: Date.now(), name, source, grade, competitionScore, releaseDate, vase, note });
            }

            saveDataToCloud('flowers', flowers);
            closeFlowerForm();
            renderFlowers();
            renderMembers(); // æ›´æ–°æˆå“¡åˆ—è¡¨çš„æ“æœ‰ç‹€æ…‹
            renderCompetitions();
        }

        function editFlower(id) {
            if (!isAuthenticated) {
                alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡å¸³è™Ÿæ‰èƒ½é€²è¡Œç·¨è¼¯');
                return;
            }
            const flower = flowers.find(f => f.id === id);
            showFlowerFormInBox(flower);
            document.getElementById('flower-btn-text').textContent = 'å–æ¶ˆç·¨è¼¯';
        }

        function deleteFlower(id) {
            if (!isAuthenticated) {
                alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡å¸³è™Ÿæ‰èƒ½é€²è¡Œç·¨è¼¯');
                return;
            }
            const flowerToDelete = flowers.find(f => f.id === id);
            if (!flowerToDelete) return;

            if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${flowerToDelete.name}ã€å—ï¼Ÿ\næ³¨æ„ï¼šé€™å°‡æœƒå¾æ‰€æœ‰æˆå“¡çš„æ“æœ‰æ¸…å–®å’Œç«¶è³½ç´€éŒ„ä¸­ç§»é™¤æ­¤èŠ±æœµï¼`)) {
                const targetName = flowerToDelete.name;
                flowers = flowers.filter(f => f.id !== id);

                // é€£å‹•åˆªé™¤
                let memberUpdated = false;
                let competitionUpdated = false;
                members.forEach(m => {
                    if (m.ownedFlowers && m.ownedFlowers.includes(targetName)) {
                        m.ownedFlowers = m.ownedFlowers.filter(f => f !== targetName);
                        memberUpdated = true;
                    }
                });
                competitions.forEach(c => {
                    if (c.selectedFlowers && c.selectedFlowers.includes(targetName)) {
                        c.selectedFlowers = c.selectedFlowers.filter(f => f !== targetName);
                        competitionUpdated = true;
                    }
                });

                saveDataToCloud('flowers', flowers);
                if (memberUpdated) saveDataToCloud('members', members);
                if (competitionUpdated) saveDataToCloud('competitions', competitions);
                renderFlowers();
                renderMembers();
                renderCompetitions();
            }
        }

        function showCompetitionForm(competition = null) {
            const isEdit = competition !== null;
            const tbody = document.getElementById('competitions-table');

            const existingForm = tbody.querySelector('.form-row');
            if (existingForm) existingForm.remove();

            const selectedMember = competition ? members.find(m => m.gameName === competition.memberName) : null;

            const formRow = document.createElement('tr');
            formRow.className = 'form-row';
            formRow.innerHTML = `
                                            <td colspan="3">
                                                <div class="form-container">
                                                    <form onsubmit="saveCompetition(event, ${isEdit ? competition.id : 'null'})">
                                                        <div style="margin-bottom: 12px;">
                                                            <select id="comp-member" onchange="updateFlowerList()" required
                                                                style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                                                                <option value="">é¸æ“‡æˆå“¡*</option>
                                                                ${members.map(m => `<option value="${m.gameName}" ${competition && competition.memberName === m.gameName ? 'selected' : ''}>${m.gameName}</option>`).join('')}
                                                            </select>
                                                        </div>

                                                        <div style="margin-top: 12px;">
                                                            <input type="text" id="comp-flower-search" placeholder="ğŸ” æœå°‹æ­¤æˆå“¡çš„èŠ±æœµ..."
                                                                onkeyup="filterCheckboxes(this, 'flower-checkboxes')"
                                                                style="width: 100%; padding: 6px; margin-bottom: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px;">

                                                            <div id="flower-checkboxes" class="checkbox-list" style="
                                                                background: white;
                                                                max-height: 200px;
                                                                overflow-y: auto;
                                                                display: grid;
                                                                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                                                                gap: 4px;
                                                                padding: 8px;
                                                                border: 1px solid #d1d5db;
                                                                border-radius: 4px;
                                                            ">
                                                                ${selectedMember ? renderFlowerCheckboxes(selectedMember, competition ? competition.selectedFlowers : [], false) : '<p style="padding: 4px; color: #6b7280; grid-column: 1/-1;">è«‹å…ˆé¸æ“‡æˆå“¡</p>'}
                                                            </div>
                                                        </div>

                                                        <div class="form-buttons" style="margin-top: 12px;">
                                                            <button type="submit" class="save-btn">ğŸ’¾ å„²å­˜</button>
                                                            <button type="button" class="form-cancel-btn" onclick="renderCompetitions()">âŒ å–æ¶ˆ</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </td>
                                        `;

            if (isEdit) {
                const rows = tbody.getElementsByTagName('tr');
                for (let i = 0; i < rows.length; i++) {
                    if (rows[i].innerHTML.includes(competition.memberName)) {
                        rows[i].replaceWith(formRow);
                        break;
                    }
                }
            } else {
                tbody.insertBefore(formRow, tbody.firstChild);
            }
        }

        function renderFlowerCheckboxes(member, selectedFlowers, disabled) {
            if (!member.ownedFlowers || member.ownedFlowers.length === 0) {
                return '<p style="padding: 4px; color: #ef4444; grid-column: 1/-1;">æ­¤æˆå“¡å°šæœªç™»è¨˜æ“æœ‰çš„èŠ±æœµï¼Œç„¡æ³•åƒåŠ ç«¶è³½ã€‚</p>';
            }

            return member.ownedFlowers.map(flowerName => `
                                                    <label class="checkbox-item" style="
                                                        display: flex;
                                                        align-items: center;
                                                        padding: 4px;
                                                        cursor: pointer;
                                                        white-space: nowrap;
                                                        overflow: hidden;
                                                        text-overflow: ellipsis;
                                                    ">
                                                        <input type="checkbox" name="comp-flowers" value="${flowerName}"
                                                            ${selectedFlowers.includes(flowerName) ? 'checked' : ''}
                                                            ${disabled ? 'disabled' : ''}>
                                                        <span style="margin-left: 6px; font-size: 13px;">${flowerName}</span>
                                                    </label>
                                                `).join('');
        }

        function updateFlowerList() {
            const memberName = document.getElementById('comp-member').value;
            const member = members.find(m => m.gameName === memberName);
            const checkboxDiv = document.getElementById('flower-checkboxes');
            const searchInput = document.getElementById('comp-flower-search'); // æŠ“æœå°‹æ¡†

            // âœ¨ åˆ‡æ›æˆå“¡æ™‚ï¼Œæ¸…ç©ºæœå°‹æ–‡å­—ï¼Œè®“ä½¿ç”¨è€…çœ‹è¦‹å…¨éƒ¨èŠ±æœµ
            if (searchInput) searchInput.value = '';

            if (member) {
                checkboxDiv.innerHTML = renderFlowerCheckboxes(member, [], false);
            } else {
                checkboxDiv.innerHTML = '<p style="padding: 8px; color: #6b7280;">è«‹å…ˆé¸æ“‡æˆå“¡</p>';
            }
        }

        function saveCompetition(event, id) {
            event.preventDefault();
            // æ‰€æœ‰äººéƒ½å¯ä»¥å„²å­˜ç«¶è³½è³‡æ–™

            const memberName = document.getElementById('comp-member').value;
            const checkboxes = document.querySelectorAll('input[name="comp-flowers"]:checked');
            const selectedFlowers = Array.from(checkboxes).map(cb => cb.value);

            if (id) {
                const index = competitions.findIndex(c => c.id === id);
                competitions[index] = { ...competitions[index], memberName, selectedFlowers };
            } else {
                competitions.push({ id: Date.now(), memberName, selectedFlowers });
            }

            saveDataToCloud('competitions', competitions);
            renderCompetitions();
        }

        // ==========================================
        // 1. æ¸²æŸ“å‡½å¼ (åŠ å…¥é»æ“Šäº‹ä»¶)
        // ==========================================

        // æ¸²æŸ“æˆå“¡æ¸…å–®
        function renderMembers() {
            const tbody = document.getElementById('members-table');
            tbody.innerHTML = '';

            members.forEach(member => {
                const flowersText = member.ownedFlowers && member.ownedFlowers.length > 0
                    ? member.ownedFlowers.join(', ') : 'ç„¡';

                const editBtn = `<button class="edit-btn" onclick="editMember(${member.id})">âœï¸</button>`;
                const deleteBtn = isAuthenticated
                    ? `<button class="delete-btn" onclick="deleteMember(${member.id})">ğŸ—‘ï¸</button>`
                    : `<span style="color:#ccc; font-size:12px; cursor: not-allowed; padding: 4px;">ğŸ”’</span>`;

                const row = document.createElement('tr');
                row.innerHTML = `
                                            <td><span class="clickable-link" onclick="showMemberDetail(${member.id})">${member.gameName}</span></td>
                                            <td>${member.gameId}</td>
                                            <td>${member.guild}</td>
                                            <td style="max-width: 250px; word-wrap: break-word;">${flowersText}</td>
                                            <td><div class="actions">${editBtn}${deleteBtn}</div></td>
                                        `;
                tbody.appendChild(row);
            });
        }

        // æ¸²æŸ“èŠ±æœµæ¸…å–® (åŠ å…¥æˆå“¡æ‰¹é‡ç®¡ç†æŒ‰éˆ•)
        function renderFlowers() {
            const tbody = document.getElementById('flowers-table');
            tbody.innerHTML = '';

            flowers.forEach(flower => {
                const owners = members.filter(m => m.ownedFlowers && m.ownedFlowers.includes(flower.name)).map(m => m.gameName);
                const gradeClass = 'grade-' + getGradeColorClass(flower.grade);

                // âœ¨ æ–°å¢ä¸­é–“é‚£å€‹ ğŸ‘¥ æŒ‰éˆ•
                const actionButtons = isAuthenticated ? `
                <button class="edit-btn" onclick="editFlower(${flower.id})" title="ç·¨è¼¯èŠ±æœµ">âœï¸</button>
                <button class="edit-btn" onclick="openDistributeModal(${flower.id})" title="ç®¡ç†æ“æœ‰è€…" style="color:#0ea5e9;">ğŸ‘¥</button>
                <button class="delete-btn" onclick="deleteFlower(${flower.id})" title="åˆªé™¤èŠ±æœµ">ğŸ—‘ï¸</button>
            ` : `<span style="color:#ccc; font-size:12px;">ğŸ”’</span>`;

                const row = document.createElement('tr');
                row.innerHTML = `
                <td><span class="clickable-link" onclick="showFlowerDetail(${flower.id})">${flower.name}</span></td>

                <td style="font-size: 13px;">${owners.length > 0 ? owners.join(', ') : 'ç„¡'}</td>

                <td><span class="${gradeClass}">${flower.grade}</span></td>
                <td>${flower.competitionScore}</td>
                <td>${flower.releaseDate || '-'}</td>
                <td>${flower.vase || '-'}</td>
                <td style="font-size: 13px; color: #4b5563;">${flower.note || '-'}</td>

                <td>${flower.source}</td>

                <td><div class="actions">${actionButtons}</div></td>
            `;
                tbody.appendChild(row);
            });
        }

        // âœ¨ èŠ±æœµç­‰ç´šæ’åºåŠŸèƒ½
        let isGradeDesc = false; // æ’åºç‹€æ…‹

        function sortFlowersByGrade() {
            // 1. åˆ‡æ›æ’åºé †åº
            isGradeDesc = !isGradeDesc;

            // 2. æ›´æ–°ç®­é ­åœ–ç¤º
            const icon = document.getElementById('grade-sort-icon');
            if (icon) icon.textContent = isGradeDesc ? 'â†“' : 'â†‘'; // â†“ä»£è¡¨é«˜ç­‰ç´š(ç´…)åœ¨ä¸Šé¢

            // 3. å®šç¾©ç­‰ç´šçš„åˆ†æ•¸ (æ¬Šé‡)ï¼Œè®“ç´…æœ€é‡ï¼Œç¶ æœ€è¼•
            const gradeWeight = {
                'ç´…': 5,
                'æ©™': 4,
                'ç´«': 3,
                'è—': 2,
                'ç¶ ': 1
            };

            // 4. åŸ·è¡Œæ’åº
            flowers.sort((a, b) => {
                // å–å‡ºç­‰ç´šçš„ç¬¬ä¸€å€‹å­— (ä¾‹å¦‚ "ç´…(ä»™å“)" å– "ç´…")
                const charA = a.grade ? a.grade.charAt(0) : '';
                const charB = b.grade ? b.grade.charAt(0) : '';

                // è½‰æ›æˆæ•¸å­—æ¬Šé‡ï¼Œå¦‚æœæ‰¾ä¸åˆ°å°±ç•¶ä½œ 0
                const weightA = gradeWeight[charA] || 0;
                const weightB = gradeWeight[charB] || 0;

                // ä¾ç…§æ¬Šé‡æ’åº
                return isGradeDesc ? (weightB - weightA) : (weightA - weightB);
            });

            // 5. é‡æ–°æ¸²æŸ“ç•«é¢
            renderFlowers();
        }

        // âœ¨ èŠ±æœµåˆ†æ•¸æ’åºåŠŸèƒ½
        let isScoreDesc = false; // è¨˜éŒ„ç›®å‰çš„æ’åºç‹€æ…‹ (false=åŸæœ¬äº‚çš„, true=ç”±é«˜åˆ°ä½)

        function sortFlowersByScore() {
            // 1. åˆ‡æ›æ’åºé †åº (é«˜->ä½ æˆ– ä½->é«˜)
            isScoreDesc = !isScoreDesc;

            // 2. æ›´æ–°ç®­é ­åœ–ç¤º
            const icon = document.getElementById('score-sort-icon');
            if (icon) icon.textContent = isScoreDesc ? 'â†“' : 'â†‘'; // â†“ä»£è¡¨ç”±é«˜åˆ°ä½

            // 3. åŸ·è¡Œæ’åº
            flowers.sort((a, b) => {
                const scoreA = parseInt(a.competitionScore) || 0;
                const scoreB = parseInt(b.competitionScore) || 0;

                // å¦‚æœæ˜¯ Desc (ç”±é«˜åˆ°ä½)ï¼Œå°±æ˜¯ B - A
                // å¦‚æœæ˜¯ Asc (ç”±ä½åˆ°é«˜)ï¼Œå°±æ˜¯ A - B
                return isScoreDesc ? (scoreB - scoreA) : (scoreA - scoreB);
            });

            // 4. é‡æ–°æ¸²æŸ“ç•«é¢
            renderFlowers();
        }

        // æ¸²æŸ“ç«¶è³½æ¸…å–®
        function renderCompetitions() {
            const tbody = document.getElementById('competitions-table');
            const guildFilter = document.getElementById('comp-guild-filter').value;

            // âœ¨ åˆ†åˆ¥å–å¾—ã€ŒèŠ±æœµæœå°‹ã€èˆ‡ã€Œæˆå“¡æœå°‹ã€çš„æ–‡å­—
            const flowerSearchText = document.getElementById('competitions-flower-search').value.toLowerCase().trim();
            const memberSearchText = document.getElementById('competitions-member-search').value.toLowerCase().trim();

            tbody.innerHTML = '';

            const filteredCompetitions = competitions.filter(comp => {
                // 1. æª¢æŸ¥å…¬æœƒ
                const member = members.find(m => m.gameName === comp.memberName);
                const memberGuild = member ? member.guild : '';
                if (guildFilter && memberGuild !== guildFilter) return false;

                // 2. âœ¨ æª¢æŸ¥æˆå“¡åç¨± (åªçœ‹ä¸‹æ–¹çš„æœå°‹æ¡†)
                if (memberSearchText && !comp.memberName.toLowerCase().includes(memberSearchText)) {
                    return false;
                }

                // 3. âœ¨ æª¢æŸ¥èŠ±æœµåç¨± (åªçœ‹ä¸Šæ–¹çš„æœå°‹æ¡†)
                if (flowerSearchText) {
                    // æŠŠè©²æˆå“¡é¸çš„æ‰€æœ‰èŠ±æ¥æˆä¸€ä¸²å­—ä¸²ä¾†æª¢æŸ¥
                    const flowersStr = comp.selectedFlowers.join(' ').toLowerCase();
                    // å¦‚æœé€™ä¸²èŠ±è£¡é¢æ²’æœ‰åŒ…å«æœå°‹çš„å­—ï¼Œå°±å‰”é™¤
                    if (!flowersStr.includes(flowerSearchText)) {
                        return false;
                    }
                }

                return true; // é€šéæ‰€æœ‰æª¢æŸ¥
            });

            // æ¸²æŸ“ç•«é¢
            filteredCompetitions.forEach(comp => {
                const row = document.createElement('tr');
                row.innerHTML = `
                                            <td><span class="clickable-link" onclick="showCompetitionDetail(${comp.id})">${comp.memberName}</span></td>
                                            <td>${comp.selectedFlowers.length > 0 ? comp.selectedFlowers.join(', ') : 'æœªé¸æ“‡'}</td>
                                            <td>
                                                <div class="actions">
                                                    <button class="edit-btn" onclick="editCompetition(${comp.id})">âœï¸</button>
                                                    <button class="delete-btn" onclick="deleteCompetition(${comp.id})">ğŸ—‘ï¸</button>
                                                </div>
                                            </td>
                                        `;
                tbody.appendChild(row);
            });

            if (filteredCompetitions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#999; padding:20px;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>';
            }
        }

        // é¡¯ç¤ºèŠ±æœµè©³ç´°è³‡æ–™
        function showFlowerDetail(id) {
            const flower = flowers.find(f => f.id === id);
            if (!flower) return;

            const owners = members.filter(m => m.ownedFlowers && m.ownedFlowers.includes(flower.name)).map(m => m.gameName);
            const gradeColor = getGradeColorCode(flower.grade);

            const html = `
                                        <div class="modal-header">
                                            <div class="modal-subtitle">èŠ±æœµæª”æ¡ˆ</div>
                                            <div class="modal-title">${flower.name}</div>
                                        </div>
                                        <div class="detail-row"><span class="detail-label">ä¾†æº</span><span class="detail-value">${flower.source}</span></div>
                                        <div class="detail-row"><span class="detail-label">ç­‰ç´š</span><span class="detail-value" style="color:${gradeColor}; font-weight:bold;">${flower.grade}</span></div>
                                        <div class="detail-row"><span class="detail-label">ç«¶è³½åˆ†æ•¸</span><span class="detail-value">${flower.competitionScore}</span></div>
                                        <div class="detail-row"><span class="detail-label">ä¸Šå¸‚æ—¥æœŸ</span><span class="detail-value">${flower.releaseDate || '-'}</span></div>
                                        <div class="detail-row"><span class="detail-label">èŠ±ç“¶</span><span class="detail-value">${flower.vase || '-'}</span></div>
                                        <div class="detail-row"><span class="detail-label">å‚™è¨»</span><span class="detail-value">${flower.note || '-'}</span></div>

                                        <div class="section-title">æ“æœ‰è€…åå–®</div>
                                        <div class="detail-value" style="text-align: left; line-height: 1.6; max-width: 100%;">
                                            ${owners.length > 0 ? owners.join(' , ') : 'ç›®å‰ç„¡äººæ“æœ‰'}
                                        </div>
                                    `;
            openModal(html);
        }

        // é¡¯ç¤ºç«¶è³½è©³ç´°è³‡æ–™ (ä¸è¨ˆç®—ç¸½åˆ†ç‰ˆ)
        function showCompetitionDetail(id) {
            const comp = competitions.find(c => c.id === id);
            if (!comp) return;

            // ç”¢ç”ŸèŠ±æœµæ¨™ç±¤ (åªé¡¯ç¤ºåå­—å’Œé¡è‰²ï¼Œä¸é¡¯ç¤ºåˆ†æ•¸)
            const flowerListHtml = comp.selectedFlowers.map(fName => {
                const fInfo = flowers.find(f => f.name === fName);
                const color = fInfo ? getGradeColorCode(fInfo.grade) : '#666';

                return `<span class="flower-tag" style="border-color:${color}40;">
                                            <span style="width:8px; height:8px; background:${color}; border-radius:50%; margin-right:6px;"></span>
                                            ${fName}
                                        </span>`;
            }).join('');

            const html = `
                                        <div class="modal-header">
                                            <div class="modal-subtitle">æœ¬é€±ç«¶è³½ç´€éŒ„</div>
                                            <div class="modal-title">${comp.memberName}</div>
                                        </div>

                                        <div class="detail-row">
                                            <span class="detail-label">ä½¿ç”¨èŠ±æœµæ•¸</span>
                                            <span class="detail-value">${comp.selectedFlowers.length} æœµ</span>
                                        </div>

                                        <div class="section-title">åƒè³½èŠ±æœµæ¸…å–®</div>
                                        <div class="tags-container">${flowerListHtml || '<span style="color:#999;">æœªé¸æ“‡èŠ±æœµ</span>'}</div>
                                    `;
            openModal(html);
        }

        // ==========================================
        // 3. è¼”åŠ©å·¥å…·
        // ==========================================

        function openModal(htmlContent) {
            const modal = document.getElementById('universal-modal');
            document.getElementById('modal-body-content').innerHTML = htmlContent;
            modal.classList.add('show');
        }

        function closeModal(event) {
            // é»æ“ŠèƒŒæ™¯æˆ–é—œé–‰æŒ‰éˆ•æ™‚è§¸ç™¼
            if (event && event.target.id !== 'universal-modal' && !event.target.classList.contains('modal-close-btn')) return;
            document.getElementById('universal-modal').classList.remove('show');
        }

        function generateFlowerTags(flowerList) {
            if (!flowerList || flowerList.length === 0) return '<span style="color:#999; font-size:13px;">ç„¡</span>';
            return flowerList.map(fName => {
                const fInfo = flowers.find(f => f.name === fName);
                const color = fInfo ? getGradeColorCode(fInfo.grade) : '#374151';
                return `<span class="flower-tag" style="color:${color}; border-color:${color}30; background:${color}08;">${fName}</span>`;
            }).join('');
        }

        function getGradeColorCode(grade) {
            if (!grade) return '#374151';
            if (grade.includes('ç´…')) return '#ef4444';
            if (grade.includes('æ©™')) return '#f97316';
            if (grade.includes('ç´«')) return '#a855f7';
            if (grade.includes('è—')) return '#3b82f6';
            if (grade.includes('ç¶ ')) return '#22c55e';
            return '#374151';
        }

        function getGradeColorClass(grade) {
            if (!grade) return 'gray';
            return grade.split(':')[0].toLowerCase()
                .replace('ç´…', 'red').replace('æ©™', 'orange').replace('ç´«', 'purple')
                .replace('è—', 'blue').replace('ç¶ ', 'green');
        }

        function editCompetition(id) {
            // æ‰€æœ‰äººéƒ½å¯ä»¥ç·¨è¼¯
            const competition = competitions.find(c => c.id === id);
            showCompetitionForm(competition);
        }

        function deleteCompetition(id) {
            // æ‰€æœ‰äººéƒ½å¯ä»¥åˆªé™¤
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç«¶è³½è¨˜éŒ„å—?')) {
                competitions = competitions.filter(c => c.id !== id);
                saveDataToCloud('competitions', competitions);
                renderCompetitions();
            }
        }
        function filterCheckboxes(input, containerId) {
            // âœ¨ é—œéµä¿®æ”¹ï¼šåŠ ä¸Š .trim() å»é™¤æ‰‹æ©Ÿè‡ªå‹•ç”¢ç”Ÿçš„ç©ºç™½
            const filter = input.value.toLowerCase().trim();

            const container = document.getElementById(containerId);
            const labels = container.getElementsByTagName('label'); // æŠ“å‡ºæ‰€æœ‰é¸é …

            for (let i = 0; i < labels.length; i++) {
                const span = labels[i].getElementsByTagName('span')[0]; // æŠ“å‡ºæ–‡å­—éƒ¨åˆ†
                if (span) {
                    const txtValue = span.textContent || span.innerText;
                    // å¦‚æœæ–‡å­—åŒ…å«æœå°‹é—œéµå­—ï¼Œå°±é¡¯ç¤ºï¼›å¦å‰‡éš±è—
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        labels[i].style.display = "";
                        labels[i].classList.remove('hidden');
                    } else {
                        labels[i].style.display = "none";
                    }
                }
            }
        }

        // è£œä¸Šé€™å€‹å‡½å¼ï¼Œé»æ“Šæˆå“¡åå­—æ‰æœƒæœ‰åæ‡‰
        function showMemberDetail(id) {
            const member = members.find(m => m.id === id);
            if (!member) return;

            const flowerTags = generateFlowerTags(member.ownedFlowers);

            const html = `
                                        <div class="modal-header">
                                            <div class="modal-subtitle">æˆå“¡è³‡è¨Š</div>
                                            <div class="modal-title">${member.gameName}</div>
                                        </div>
                                        <div class="detail-row"><span class="detail-label">éŠæˆ² ID</span><span class="detail-value">${member.gameId}</span></div>
                                        <div class="detail-row"><span class="detail-label">æ‰€å±¬å…¬æœƒ</span><span class="detail-value">${member.guild}</span></div>

                                        <div class="section-title">æ“æœ‰çš„èŠ±æœµ (${member.ownedFlowers ? member.ownedFlowers.length : 0})</div>
                                        <div class="tags-container">${flowerTags}</div>
                                    `;
            openModal(html);
        }

        // ==========================================
        // ğŸ¢ å…¬æœƒç®¡ç†åŠŸèƒ½
        // ==========================================

        // æ¸²æŸ“å…¬æœƒç®¡ç†å€ (é¡¯ç¤ºæ¨™ç±¤)
        function renderGuildManager() {
            const container = document.getElementById('guild-list-display');
            if (!container) return;

            container.innerHTML = guilds.length === 0
                ? '<span style="color:#94a3b8;">å°šæœªå»ºç«‹ä»»ä½•å…¬æœƒï¼Œè«‹ä¸Šæ–¹è¼¸å…¥ä¸¦æ–°å¢ã€‚</span>'
                : '';

            guilds.forEach((g, index) => {
                const tag = document.createElement('div');
                tag.className = 'guild-tag';
                tag.innerHTML = `
                ${g}
                <span class="guild-delete-btn" onclick="deleteGuild(${index})">Ã—</span>
            `;
                container.appendChild(tag);
            });

            // æ¯æ¬¡æ›´æ–°å…¬æœƒåˆ—è¡¨æ™‚ï¼Œé †ä¾¿æ›´æ–°ã€Œç«¶è³½é é¢ã€çš„ç¯©é¸é¸å–®
            initCompGuildFilter();
        }

        // æ–°å¢å…¬æœƒ
        function addGuild() {
            if (!isAuthenticated) return alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡');

            const input = document.getElementById('new-guild-name');
            const name = input.value.trim();

            if (!name) return alert('è«‹è¼¸å…¥å…¬æœƒåç¨±');
            if (guilds.includes(name)) return alert('æ­¤å…¬æœƒå·²ç¶“å­˜åœ¨');

            guilds.push(name);
            saveDataToCloud('guilds', guilds); // å„²å­˜åˆ°é›²ç«¯

            input.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
            renderGuildManager(); // æ›´æ–°ç•«é¢
        }

        // åˆªé™¤å…¬æœƒ
        function deleteGuild(index) {
            if (!isAuthenticated) return alert('è«‹å…ˆç™»å…¥ç®¡ç†å“¡');

            const guildName = guilds[index];
            if (confirm(`ç¢ºå®šè¦åˆªé™¤å…¬æœƒã€Œ${guildName}ã€å—ï¼Ÿ\n(æ³¨æ„ï¼šç¾æœ‰æˆå“¡çš„å…¬æœƒè³‡æ–™ä¸æœƒè¢«æ¸…é™¤ï¼Œä½†é¸å–®ä¸­å°‡ä¸å†é¡¯ç¤º)`)) {
                guilds.splice(index, 1);
                saveDataToCloud('guilds', guilds);
                renderGuildManager();
            }
        }

        // âœ¨ å…¨é¸/å…¨ä¸é¸åŠŸèƒ½ (æ”¯æ´æœå°‹ç¯©é¸)
        function toggleAllFlowers(checkStatus) {
            const container = document.getElementById('member-flower-list');
            const labels = container.getElementsByTagName('label');

            for (let i = 0; i < labels.length; i++) {
                // åªé‡å°ç›®å‰ã€Œé¡¯ç¤ºä¸­ã€çš„é¸é …æ“ä½œ (æ”¯æ´æœå°‹å¾Œå…¨é¸)
                if (labels[i].style.display !== 'none' && !labels[i].classList.contains('hidden')) {
                    const checkbox = labels[i].querySelector('input[type="checkbox"]');
                    if (checkbox) {
                        checkbox.checked = checkStatus;
                    }
                }
            }

        }

        // ==========================================
        // ğŸ‘¥ èŠ±æœµæ‰¹é‡æ´¾ç™¼åŠŸèƒ½ (ç®¡ç†å“¡å°ˆç”¨)
        // ==========================================

        let currentDistributeFlowerId = null;

        function openDistributeModal(flowerId) {
            if (!isAuthenticated) return alert('æ¬Šé™ä¸è¶³');

            const flower = flowers.find(f => f.id === flowerId);
            if (!flower) return;

            currentDistributeFlowerId = flowerId;

            // ç”¢ç”Ÿæˆå“¡åˆ—è¡¨ HTML
            const membersHtml = members.map(m => {
                const hasFlower = m.ownedFlowers && m.ownedFlowers.includes(flower.name);
                return `
                <label class="checkbox-item" style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px dashed #eee;">
                    <div style="display:flex; align-items:center;">
                        <input type="checkbox" name="distribute-member" value="${m.id}" ${hasFlower ? 'checked' : ''}>
                        <span style="margin-left:8px; font-weight:bold;">${m.gameName}</span>
                        <span style="margin-left:8px; font-size:12px; color:#666; background:#f3f4f6; padding:2px 6px; border-radius:4px;">${m.guild}</span>
                    </div>
                    ${hasFlower ? '<span style="font-size:12px; color:#16a34a;">å·²æ“æœ‰</span>' : ''}
                </label>
            `;
            }).join('');

            const html = `
            <div class="modal-header">
                <div class="modal-subtitle">æ‰¹é‡ç®¡ç†æ“æœ‰è€…</div>
                <div class="modal-title" style="color:#2563eb;">${flower.name}</div>
            </div>

            <div style="margin-bottom: 10px;">
                <input type="text" placeholder="ğŸ” æœå°‹æˆå“¡..." oninput="filterDistributeList(this)"
                       style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px;">
            </div>

            <div style="margin-bottom: 10px; display: flex; gap: 8px;">
                <button type="button" onclick="toggleAllDistribute(true)" style="padding: 4px 12px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer;">âœ… å…¨é¸</button>
                <button type="button" onclick="toggleAllDistribute(false)" style="padding: 4px 12px; background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer;">â¬œ å…¨ä¸é¸</button>
            </div>

            <div id="distribute-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px;">
                ${membersHtml}
            </div>

            <div class="form-buttons" style="margin-top: 16px;">
                <button onclick="saveFlowerDistribution()" class="save-btn" style="width:100%; justify-content:center;">ğŸ’¾ å„²å­˜è®Šæ›´</button>
            </div>
        `;

            openModal(html);
        }

        // å„²å­˜æ´¾ç™¼çµæœ
        function saveFlowerDistribution() {
            if (!currentDistributeFlowerId) return;

            const flower = flowers.find(f => f.id === currentDistributeFlowerId);
            if (!flower) return;

            const checkboxes = document.querySelectorAll('input[name="distribute-member"]');
            const checkedMemberIds = Array.from(checkboxes).filter(cb => cb.checked).map(cb => parseInt(cb.value));

            let isUpdated = false;

            // éæ­·æ‰€æœ‰æˆå“¡ï¼Œæ›´æ–°ä»–å€‘çš„æ“æœ‰ç‹€æ…‹
            members.forEach(m => {
                const shouldHave = checkedMemberIds.includes(m.id);
                const actuallyHas = m.ownedFlowers && m.ownedFlowers.includes(flower.name);

                if (shouldHave && !actuallyHas) {
                    // æ‡‰è©²æœ‰ä½†æ²’æœ‰ -> åŠ å…¥
                    if (!m.ownedFlowers) m.ownedFlowers = [];
                    m.ownedFlowers.push(flower.name);
                    isUpdated = true;
                } else if (!shouldHave && actuallyHas) {
                    // ä¸è©²æœ‰ä½†æœ‰ -> ç§»é™¤
                    m.ownedFlowers = m.ownedFlowers.filter(f => f !== flower.name);
                    isUpdated = true;
                }
            });

            if (isUpdated) {
                saveDataToCloud('members', members);
                renderFlowers(); // æ›´æ–°åˆ—è¡¨é¡¯ç¤ºçš„æ“æœ‰è€…
                renderMembers(); // æ›´æ–°æˆå“¡åˆ—è¡¨
                closeModal();
                alert(`å·²æˆåŠŸæ›´æ–°ã€Œ${flower.name}ã€çš„æ“æœ‰è€…åå–®ï¼`);
            } else {
                closeModal();
            }
        }

        // æœå°‹ç¯©é¸æˆå“¡
        function filterDistributeList(input) {
            const filter = input.value.toLowerCase().trim();
            const list = document.getElementById('distribute-list');
            const labels = list.getElementsByTagName('label');

            for (let label of labels) {
                const text = label.textContent.toLowerCase();
                label.style.display = text.includes(filter) ? '' : 'none';
            }
        }

        // å…¨é¸/å…¨ä¸é¸ (åƒ…é‡å°ç¯©é¸å¾Œçš„é¡¯ç¤ºé …ç›®)
        function toggleAllDistribute(checked) {
            const list = document.getElementById('distribute-list');
            const labels = list.getElementsByTagName('label');

            for (let label of labels) {
                if (label.style.display !== 'none') {
                    const cb = label.querySelector('input[type="checkbox"]');
                    if (cb) cb.checked = checked;
                }
            }
        }

        window.onload = init;
    </script>
</body>
</html>